<!DOCTYPE html>
<html>
   <head>
      <title>VSCode Flavored Markdown Preview</title>
      <link rel="icon" type="image/svg" href="icon.svg" />
      <meta name="viewport" content="width=device-width,initial-scale=1" />
      <link
         rel="stylesheet"
         href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css"
      />
      <link
         rel="stylesheet"
         href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/4.0.0/github-markdown.min.css"
      />
      <link
         rel="stylesheet"
         href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/styles/github.min.css"
      />
      <link rel="preconnect" href="https://fonts.googleapis.com" />
      <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
      <link
         href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:ital,wght@0,100..800;1,100..800&family=Noto+Sans+SC:wght@100..900&display=swap"
         rel="stylesheet"
      />
      <script type="module">
         /* 这个工具使用了以下库 / 资源：
            - markdown-it
            - vscode/markdown-it-katex
            - katex
            - highlight.js
            - mermaid
            - github-markdown-css
            - JetBrains Mono, Noto Sans SC
         */
         import markdownIt from "https://cdn.jsdelivr.net/npm/markdown-it@14.1.0/+esm";
         import vscodemarkdownItKatex from "https://cdn.jsdelivr.net/npm/@vscode/markdown-it-katex@1.1.2/+esm";
         import highlightjs from "https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/+esm";
         import mermaid from "https://cdn.jsdelivr.net/npm/mermaid@11.12.2/+esm";

         // 创建 markdown-it 实例
         const MarkdownIt = markdownIt({
            html: true,
            highlight: function (str, lang) {
               if (lang && highlightjs.getLanguage(lang)) {
                  try {
                     return highlightjs.highlight(str, { language: lang })
                        .value;
                  } catch (err) {}
               }
               return "";
            },
         });
         MarkdownIt.use(vscodemarkdownItKatex.default);

         // 将 textarea 中的 Raw 渲染到 Preview 区域
         window.renderRaw = () => {
            document.querySelector("#preview").innerHTML = MarkdownIt.render(
               document.querySelector("#raw").value
            );
            mermaid.run({
               querySelector: ".language-mermaid",
            });
         };

         // 监测 Raw 更新
         let lastEdit = 0,
            lastEditId = 0;
         document.querySelector("#raw").addEventListener("input", () => {
            let id = ++lastEditId;
            lastEdit = new Date().getTime();
            setTimeout(() => {
               if (new Date().getTime() - lastEdit > 160 && lastEditId == id) {
                  localStorage.setItem(
                     "Raw",
                     document.querySelector("#raw").value
                  );
                  window.renderRaw();
               }
            }, 200);
         });

         // 初始化 Raw
         if (localStorage.getItem("Raw") == null) {
            localStorage.setItem(
               "Raw",
               '## VSCode Flavored Markdown Preview\n\n这是 **一个简易的 Markdown 预览工具**，其表现与 Visual Studio Code 中的 Markdown 预览功能相近。您可以点击上方的“Print”、并 **使用“另存为 PDF”将您的 Markdown 文档保存为高质量的 PDF 文件**。  \n\n**提示**\n\n- 您可以在 *打印选项* 中勾选 *背景图形* 以获得更美观的代码高亮。   \n- 如果您需要预览含有本地资源的 Markdown 文件，您可以：  \n   1. 将这个网页保存（Ctrl + S）到该 Markdown 文件所属的文件夹中；  \n   2. 在本地打开所保存的网页；  \n   3. 将该 Markdown 文件拖拽到本地打开的页面中。\n\n**文本一**\n\n常用的等价无穷小有 $\\sin x \\sim x$、$\\ln(1 + x) \\sim x$、$a^x - 1 \\sim x \\ln a$、$[(1+x)^\\alpha - 1] \\sim \\alpha x$ 等。\n\n**文本二**\n\n```c\nprintf("Hello, world!"); // 输出 Hello, world!\n```\n\n**文本三**\n\n<div align="center">\n   这是一段居中文本\n</div>'
            );
         }
         document.querySelector("#raw").value = localStorage.getItem("Raw");
         window.renderRaw();
      </script>
      <style>
         .root {
            width: calc(100% - 4.8em);
            height: calc(100% - 4.8em);
            left: 0;
            top: 0;
            position: absolute;
            margin: 2.4em;
            display: flex;
            flex-direction: column;
            gap: 0.8em;
         }

         .root > .title {
            font-family: "JetBrains Mono", "Noto Sans SC", monospace;
            display: flex;
            justify-content: space-between;
         }

         .root > .title > .name {
            font-size: 1.4em;
         }

         .root > .title > .btn-preview {
            border: none;
            background: #eceff1;
            border: 1px solid #b0bec5;
            color: #37474f;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.16);
            font-size: 0.96em;
            padding: 0.25em 1em;
            border-radius: 4px;
            cursor: pointer;
            font-family: "JetBrains Mono", "Noto Sans SC", monospace;
            transition: 0.24s background, 0.24s box-shadow;
         }

         .root > .title > .btn-preview:active {
            background: #e9ecf1;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.16);
         }

         .root > .main {
            display: flex;
            height: inherit;
            gap: 0.8em;
         }

         @media screen and (max-width: 480px) {
            .root > .main {
               flex-direction: column;
            }
         }

         .root > .main > textarea#raw {
            outline: none;
            resize: none;
            background: #f5f5f5;
            border: 1px #cfd8dc solid;
            padding: 1.4rem;
            border-radius: 8px;
            flex: 1;
            box-sizing: border-box;
            font-family: "JetBrains Mono", "Noto Sans SC", monospace;
            font-optical-sizing: auto;
            font-style: normal;
         }

         div#preview {
            flex: 1;
            border: 1px #cfd8dc solid;
            overflow-y: auto;
            padding: 1.4rem;
            border-radius: 8px;
            font-family: "Noto Sans SC", sans-serif;
            font-optical-sizing: auto;
            font-style: normal;
         }

         .markdown-body pre,
         .markdown-body code {
            font-family: "JetBrains Mono", "Noto Sans SC", monospace !important;
            text-wrap: auto !important;
         }

         .markdown-body pre:has(.language-mermaid) {
            background: none;
         }

         body > div#preview.fullscreen {
            z-index: 1000;
            background: #fff;
            margin: 1.6rem;
            position: relative;
            border: none;
         }

         .print-tip {
            position: fixed;
            right: 2em;
            bottom: 2em;
            background: #eceff1;
            border: 1px solid #b0bec5;
            color: #37474f;
            padding: 0.5em 1em;
            font-size: 0.92em;
            border-radius: 6px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            font-weight: 600;
            user-select: none;
            cursor: pointer;
            transition: 0.16s opacity;
         }

         .print-tip:hover {
            opacity: 0;
            cursor: default;
         }

         .hidden { display: none; }

         @media print {
            .print-tip { display: none; }
         }
      </style>
   </head>
   <body>
      <div class="root">
         <div class="title">
            <div class="name">VSCode Flavored Markdown Preview</div>
            <button class="btn-preview">Print</button>
            <script>
               // 全屏 Preview
               document
                  .querySelector(".btn-preview")
                  .addEventListener("click", () => {
                     document.title = "Markdown File";
                     const origin = document.querySelector("#preview");
                     origin.classList.add("fullscreen");
                     document.body.append(origin);
                     document.querySelector(".root").classList.add("hidden");
                     document.querySelector(".print-tip").classList.remove("hidden");
                     window.print();
                  });
            </script>
         </div>
         <div class="main">
            <textarea id="raw"></textarea>
            <div id="preview" class="markdown-body"></div>
         </div>
      </div>
      <div class="print-tip hidden">使用打印网页中的“另存为 PDF”来导出 PDF</div>
      <script>
         // 监听 File drag and drop
         // https://developer.mozilla.org/zh-CN/docs/Web/API/HTML_Drag_and_Drop_API/File_drag_and_drop

         document.body.addEventListener("dragover", (evt) => {
            evt.preventDefault();
         });

         document.body.addEventListener("drop", async (evt) => {
            evt.preventDefault();

            for (let i = 0; i < evt.dataTransfer.items.length; i++) {
               if (evt.dataTransfer.items[i].kind == "file") {
                  document.querySelector("#raw").value =
                     await evt.dataTransfer.items[i].getAsFile().text();
                  renderRaw();
                  break;
               }
            }
         });
      </script>
   </body>
</html>
